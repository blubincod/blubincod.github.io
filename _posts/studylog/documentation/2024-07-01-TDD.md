---
layout: post
title: "WebFluxë€ ë¬´ì—‡ì´ê³ , MVCì™€ ì°¨ì´"
description: >
    ìŠ¤í”„ë§ì— ë³´ì•ˆì„ ì ìš©í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ìŠ¤í”„ë§ ë³´ì•ˆ(Spring Security)ì— ëŒ€í•´ ì•Œì•„ë³´ê¸°.
categories: [studylog, documentation]
related_posts: [/studylog/documentation/Spring&SpringBoot/, 
/studylog/documentation/SpringBoot-S2S/,
/studylog/documentation/SpringBoot-Actuator/]
comments: false
sitemap: false
cover:  false
image: /assets/study/spring/springBoot/Authentication-Authorization.jpg
---

* this unordered seed list will be replaced by toc as unordered list 
{:toc}

## ë³´ì•ˆ ìš©ì–´ ì•Œì•„ë‘ê¸°
<hr/>

```md
ì¸ì¦(Authentication)
- ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ í™•ì¸í•˜ëŠ” ë‹¨ê³„.

ì¸ê°€(Authorization)
- ì¸ì¦ì„ í†µí•´ ê²€ì¦ëœ ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ë¶€ì˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ê¶Œë¦¬ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •.

ì ‘ê·¼ ì£¼ì²´(Principal)
- ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì£¼ì²´.
```

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°(Spring Security)
<hr/>
> ì¸ì¦, ì¸ê°€ ë“±ì˜ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬.


### ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ ë™ì‘ êµ¬ì¡°
<hr/>
Spring Security ì„œë¸”ë¦¿ í•„í„°(Servlet Filter) ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©°, DispatcherServlet ì•ì— í•„í„°ê°€ ë°°ì¹˜ë˜ì–´ ìˆë‹¤.

í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìš”ì²­ì„ ë³´ë‚´ë©´ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆëŠ” URIë¥¼ í™•ì¸

í•„í„°ì™€ ì„œë¸”ë¦¿ì„ ë§¤í•‘


DelegatingFilterProxy
{:.figcaption}

DelegatingFilterProxy
> ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆì˜ ìƒëª…ì£¼ê¸°ì™€ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…ìŠ¤íŠ¸(Application Context) ì‚¬ì´ì—ì„œ ë‹¤ë¦¬ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” í•„í„° êµ¬í˜„ì²´.
í•„í„°ì²´ì¸ í”„ë¡ì‹œëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ ì„¤ì •ì— ì˜í•´ ìë™ ìƒì„±ëœë‹¤.

í•„í„°ì²´ì¸ í”„ë¡ì‹œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë³´ì•ˆ í•„í„°ì²´ì¸ì€ List í˜•ì‹ìœ¼ë¡œ ë‹´ì„ ìˆ˜ ìˆê² ì„¤ì •ë˜ì–´ ìˆì–´ URI íŒ¨í„´ì— ë”°ë¼ íŠ¹ì • ë³´ì•ˆ í•„í„° ì²´ì¸ì„ ì„ íƒí•´ì„œ ì‚¬ìš©.

```md
- ChannelProcessingFilter
- WebAsyncManagerIntegerationFilter
- SecurityContextPersitenceFilter
- HeaderWriterFilter
- CorsFilter
- CsrfFilter
- LogoutFilter
- OAuth2AuthorizationRequestRedirectFilter
- Saml2WebSsoAuthenticationRequestFilter
- X509AuthenticationFilter
- AbstractPreAuthenticatedProcessingFilter
- CasAuthenticationFilter
- OAuth2LoginAuthenticationFilter //ì´ê±° ì±…ì—ëŠ” ì˜¤íƒ€.
- Saml2WebSsoAuthenticationFilter
- UsernamePasswordAuthenticationFilter
- OpenIDAuthenticationFilter
- DefaultLoginPageGeneratingFilter
- DefaultLogoutPageGeneratingFilter
- ConcurrentSessionFilter
- DigestAuthenticationFilter
- BearerTokenAuthenticationFilter
- BasicAuthenticationFilter
- SecurityContextHolderAwareRequestFilter
- JaasApiIntergrationFilter
- RememberMeAuthenticationFilter
- AnonymousAuthenticationFilter
- OAuth2AuthorizationCodeGrantFilter
- SessionManagementFilter
- ExceptionTranslationFilter
- FilterSecurityInterceptor
- SwitchUserFilter
```
í•„í„°ì˜ ì‹¤í–‰ ìˆœì„œ
{:.figcaption}

ë³´ì•ˆ í•„í„°ì²´ì¸ì€ WebSecurityConfigurerAdapter í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì•„ ì„¤ì • ê°€ëŠ¥.

<a href="https://docs.spring.io/spring-security/site/docs/5.5.3/reference/html5/">Spring Securityì— ëŒ€í•œ ê³µì‹ ë¬¸ì„œ</a>

## JWT(Json Web Token)
<hr/>

> ë‹¹ì‚¬ì ê°„ì— ì •ë³´ë¥¼ JSON í˜•íƒœë¡œ ì•ˆì •í•˜ê²Œ ì „ì†¡í•˜ê¸° ìœ„í•œ í† í°.

- URLë¡œ ì´ìš©í•  ìˆ˜ ìˆëŠ” ë¬¸ìì—´ë¡œë§Œ êµ¬ì„±
- ë””ì§€í„¸ ì„œëª…ì´ ì ìš©ë˜ì–´ ìˆì–´ ì‹ ë¢°í•  ìˆ˜ ìˆìŒ
- ì£¼ì†Œ ì„œë²„ì™€ì˜ í†µì‹ ì—ì„œ ê¶Œí•œ ì¸ê°€ë¥¼ ìœ„í•´ ì‚¬ìš©

### JWT êµ¬ì¡°
<hr/>

> ì ìœ¼ë¡œ êµ¬ë¶„ëœ ì•„ë˜ì˜ ì„¸ ë¶€ë¶„ìœ¼ë¡œ êµ¬ì„±

- í—¤ë”(Header)
- ë‚´ìš©(Payload)
- ì„œëª…(Signature)

#### í˜œë”
<hr>

> ê²€ì¦ê³¼ ê´€ë ¨ëœ ë‚´ìš© ë‹´ê³  ìˆìŒ.

#### ë‚´ìš©
<hr>

> í† í°ì— ë‹´ëŠ” ì •ë³´ë¥¼ í¬í•¨í•˜ë©°, í¬í•¨ëœ ì†ì„±ë“¤ì€ í´ë ˆì„(Claim)ì´ë¼ í•˜ë©°, ì„¸ê°€ì§€ë¡œ ë¶„ë¥˜.

- ë“±ë¡ëœ í´ë ˆì„
- ê³µê°œ í´ë ˆì„
- ë¹„ê³µê°œ í´ë ˆì„

#### ì„œëª…
<hr>

> ì¸ì½”ë”©ëœ í—¤ë”, ì¸ì½”ë”©ëœ ë‚´ìš©, ë¹„ë°€í‚¤, í—¤ë”ì˜ ì•Œê³ ë¦¬ì¦˜ ì†ì„±ê°’ì„ ê°€ì ¸ì™€ ìƒì„±.
## Spring Securityì™€ JWT ì ìš©í•´ë³´ê¸°
<hr/>

### ì˜ì¡´ì„± ì¶”ê°€
```java
<dependencies>
    ...
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artidactId>
        <version>0.9.1</version>
    </dependency>
    ...
</dependencies>
```
Spring Securityì™€ JWT ì˜ì¡´ì„± ì¶”ê°€
{:.figcaption}

### UserDetails ì¸í„°í˜ì´ìŠ¤
> ì…ë ¥ëœ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ê°€ì§€ê³  ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ëŠ” ì—­í• ì„ ìˆ˜í–‰.
 
ë©”ì„œë“œ
{:.lead}
- getAuthorities() : ê³„ì •ì´ ê°€ì§€ê³  ìˆëŠ” ê¶Œí•œ ëª©ë¡ ë¦¬í„´
- getPassword() : ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ ë¦¬í„´
- getUsername() : ê³„ì • ì´ë¦„ ë¦¬í„´
- isAccountNonExpired() : ê³„ì •ì´ ë§Œë£ŒëëŠ”ì§€ ë¦¬í„´ -> trueëŠ” ì™„ë£Œë˜ì§€ ì•ŠìŒ
- isAccountNonLocked() : ê³„ì •ì´ ì ê²¨ìˆëŠ”ì§€ ë¦¬í„´ -> trueëŠ” ì ê¸°ì§€ ì•ŠìŒ
- isCredentialNonExpired() : ë¹„ë°€ë²ˆí˜¸ê°€ ë§Œë£ŒëëŠ”ì§€ ë¦¬í„´ -> trueëŠ” ë§Œë£Œë˜ì§€ ì•ŠìŒ
- isEnabled() : ê³„ì •ì´ í™œì„±í™”ë¼ ìˆëŠ”ì§€ ë¦¬í„´ -> trueëŠ” í™œì„±í™” ìƒíƒœ

### JwtTokenProvider êµ¬í˜„
```java
@Component
@RequiredArgsConstructor
public class JwtTokenProvider {

    private final Logger LOGGER = LoggerFactory.getLogger(JwtTokenProvider.class);
    private final UserDetailsService userDetailsService;

    // secretKey ê°’ ì •ì˜
    @Value("${springboot.jwt.secret}")
    private String secretKey = "secretKey";
    private final long tokenValidMillisecond = 1000L * 60 * 60; // 1ì‹œê°„ í† í° ìœ íš¨

    // secretKeyë¥¼ Base64 í˜•ì‹ìœ¼ë¡œ ì¸ì½”ë”©
    @PostConstruct
    protected void init() {
        LOGGER.info("[init] JwtTokenProvider ë‚´ secretKey ì´ˆê¸°í™” ì‹œì‘");
        System.out.println(secretKey);
        secretKey = Base64.getEncoder().encodeToString(secretKey.getBytes(StandardCharsets.UTF_8));
        System.out.println(secretKey);
        LOGGER.info("[init] JwtTokenProvider ë‚´ secretKey ì´ˆê¸°í™” ì™„ë£Œ");
    }

    // JWT í† í° ìƒì„±
    public String createToken(String userUid, List<String> roles) {
        LOGGER.info("[createToken] í† í° ìƒì„± ì‹œì‘");
        Claims claims = Jwts.claims().setSubject(userUid);
        claims.put("roles", roles);

        Date now = new Date();
        String token = Jwts.builder()
            .setClaims(claims)
            .setIssuedAt(now)
            .setExpiration(new Date(now.getTime() + tokenValidMillisecond))
            .signWith(SignatureAlgorithm.HS256, secretKey) // ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜, secret ê°’ ì„¸íŒ…
            .compact();

        LOGGER.info("[createToken] í† í° ìƒì„± ì™„ë£Œ");
        return token;
    }

    // JWT í† í°ìœ¼ë¡œ ì¸ì¦ ì •ë³´ ì¡°íšŒ
    public Authentication getAuthentication(String token) {
        LOGGER.info("[getAuthentication] í† í° ì¸ì¦ ì •ë³´ ì¡°íšŒ ì‹œì‘");
        UserDetails userDetails = userDetailsService.loadUserByUsername(this.getUsername(token));
        LOGGER.info("[getAuthentication] í† í° ì¸ì¦ ì •ë³´ ì¡°íšŒ ì™„ë£Œ, UserDetails UserName : {}",
            userDetails.getUsername());
        return new UsernamePasswordAuthenticationToken(userDetails, "",
            userDetails.getAuthorities());
    }

    // JWT í† í°ì—ì„œ íšŒì› êµ¬ë³„ ì •ë³´ ì¶”ì¶œ
    public String getUsername(String token) {
        LOGGER.info("[getUsername] í† í° ê¸°ë°˜ íšŒì› êµ¬ë³„ ì •ë³´ ì¶”ì¶œ");
        String info = Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token).getBody()
            .getSubject();
        LOGGER.info("[getUsername] í† í° ê¸°ë°˜ íšŒì› êµ¬ë³„ ì •ë³´ ì¶”ì¶œ ì™„ë£Œ, info : {}", info);
        return info;
    }

     // HTTP Request Headerì— ì„¤ì •ëœ í† í° ê°’ì„ ê°€ì ¸ì˜´
    public String resolveToken(HttpServletRequest request) {
        LOGGER.info("[resolveToken] HTTP í—¤ë”ì—ì„œ Token ê°’ ì¶”ì¶œ");
        return request.getHeader("X-AUTH-TOKEN");
    }

    // JWT í† í°ì˜ ìœ íš¨ê¸°ê°„ ì²´í¬
    public boolean validateToken(String token) {
        LOGGER.info("[validateToken] í† í° ìœ íš¨ ì²´í¬ ì‹œì‘");
        try {
            Jws<Claims> claims = Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token);
            LOGGER.info("[validateToken] í† í° ìœ íš¨ ì²´í¬ ì™„ë£Œ");
            return !claims.getBody().getExpiration().before(new Date());
        } catch (Exception e) {
            LOGGER.info("[validateToken] í† í° ìœ íš¨ ì²´í¬ ì˜ˆì™¸ ë°œìƒ");
            return false;
        }
    }
}
```
JwtTokenProvider êµ¬í˜„ ì½”ë“œ
{:.figcaption}

### JwtAuthenticationFilter êµ¬í˜„
>

```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final Logger LOGGER = LoggerFactory.getLogger(JwtAuthenticationFilter.class);
    private final JwtTokenProvider jwtTokenProvider;

    public JwtAuthenticationFilter(JwtTokenProvider jwtTokenProvider) {
        this.jwtTokenProvider = jwtTokenProvider;
    }

    @Override
    protected void doFilterInternal(HttpServletRequest servletRequest,
        HttpServletResponse servletResponse,
        FilterChain filterChain) throws ServletException, IOException {
        String token = jwtTokenProvider.resolveToken(servletRequest);
        LOGGER.info("[doFilterInternal] token ê°’ ì¶”ì¶œ ì™„ë£Œ. token : {}", token);

        LOGGER.info("[doFilterInternal] token ê°’ ìœ íš¨ì„± ì²´í¬ ì‹œì‘");
        if (token != null && jwtTokenProvider.validateToken(token)) {
            Authentication authentication = jwtTokenProvider.getAuthentication(token);
            SecurityContextHolder.getContext().setAuthentication(authentication);
            LOGGER.info("[doFilterInternal] token ê°’ ìœ íš¨ì„± ì²´í¬ ì™„ë£Œ");
        }

        filterChain.doFilter(servletRequest, servletResponse);
    }
}
```
Spring JwtAuthenticationFilter êµ¬í˜„ ì½”ë“œ
{:.figcaption}

### SecurityConfiguration êµ¬í˜„
> Spring Securityì™€ ê´€ë ¨ëœ ì„¤ì •

```java
@Configuration
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {
    
    private final JwtTokenProvider jwtTokenProvider;
    
    @Autowired
    public SecurityConfiguration(JwtTokenProvider jwtTokenProvider){
        this.jwtTokenProvider = jwtTokenProvider;
    }
    
    @Override
    protected void configure(HttpSecurity httpSecurity) throws Exception{
        httpSecurity.httpBasic().disable()
                
                .csrf().disable()
                
                .sessionManagement()
                .sessionCreationPolicy(
                        SessionCreationPolicy.STATELESS)
                .and()
                .authorizeRequests()
                .antMatchers("/sign-api/sign-in", "/sign-api/sign-up",
                        "/sign-api/exception").permitAll()
                .antMatchers(HttpMethod.GET, "/product/**").permitAll()
                .antMatchers("**exception**").permitAll()
                
                .anyRequest().hasRole("ADMIN")
                
                .and()
                .exceptionHandling().accessDeniedHandler(new CustomAccessDeniedHandler())
                .and()
                .exceptionHandling().authenticationEntryPoint(new CustomAuthenticationEntryPoint())
                
                .and()
                .addFilterBefore(new JwtAuthenticationFilter(jwtTokenProvider),
                        UsernamePasswordAuthenticationFilter.class);
    }
    
    @Override
    public void configure(WebSecurity webSecurity){
        webSecurity.ignoring().antMatchers("/v2/api-docs", "/swagger-resources/**",
                "/swagger-ui.html", "/webjars/**", "/swagger/**", "/sign-api/exception");
    }   
}
```

SecurityConfiguration êµ¬í˜„ ì½”ë“œ
{:.figcaption}

> ëŒ€í‘œì ì¸ ê¸°ëŠ¥
- ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ê¶Œí•œ ì„¤ì • 
- ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ ì²˜ë¦¬
- ì¸ì¦ ë¡œì§ ì»¤ìŠ¤í„°ë§ˆì´ì§•
- csrf, cors ë“±ì˜ Spring Security ì„¤ì •

## ì •ë¦¬
Spring Securityë¥¼ í†µí•´ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ë¡œê·¸ì¸ê³¼ íšŒì›ê°€ì… ë¿ë§Œ ì•„ë‹ˆë¼<br>
OAuthë‚˜ ì†Œì…œ ë¡œê·¸ì¸ì„ ì—°ë™í•˜ì—¬ êµ¬í˜„ë„ ê°€ëŠ¥í•˜ë©° ì„±ëŠ¥ìƒì˜ ì´ì ì„ ì‚´ë¦¬ê¸° ìœ„í•´ ì ìš©í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆë‹¤.<br>
ê°œë°œí•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë”°ë¼ í˜¹ì€ ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ì— ë§ê²Œ ì˜ í™œìš©í•˜ë„ë¡ í•˜ì.
{:.lead}

## ğŸ“„ ì°¸ê³ ë¬¸ì„œ
<hr>
<a href="https://www.aladin.co.kr/shop/wproduct.aspx?ItemId=296591989">ìŠ¤í”„ë§ ë¶€íŠ¸ í•µì‹¬ ê°€ì´ë“œ</a> ì±…ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

Continue with [ìŠ¤í”„ë§? ìŠ¤í”„ë§ ë¶€íŠ¸?](2024-05-21-Spring&SpringBoot.md){:.heading.flip-title}
{:.read-more}