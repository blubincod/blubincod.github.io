---
layout: page
title: "í’€ìŠ¤íƒ ë§›ë³´ê¸°8-Join & Login"
author: author1
comments: true
description: >
hide_description: true
sitemap: true
---

* this unordered seed list will be replaced by toc as unordered list 
{:toc}

## User
### Model ìƒì„±
src/models/User.js
```js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    password: { type: String, required: true },
});
const User = mongoose.model("User", userSchema);

export default User;
```

init.jsì— User ëª¨ë¸ import
```js
import "./models/User.js";
```
=> DBì—ê²Œ ì•Œë ¤ì£¼ëŠ” ê³¼ì •

### form ìƒì„±
íšŒì›ê°€ì… form ì‘ì„±
src/views/join.pug
```js
    form(method="POST")
        input(name="username" type="text" placeholder="ì•„ì´ë””" required)
        input(name="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required)
        input(name="nickname" type="text" placeholder="ë‹‰ë„¤ì„" required)
        input(name="email" type="email" placeholder="ì´ë©”ì¼" required)
        input(type="submit" value="ê°€ì…í•˜ê¸°")
```


formì—ì„œ ë°›ì€ ì •ë³´ postí•˜ê¸°
src/controllers/userController.js
```js
export const postJoin = async (req, res) => {
  const { username, password, nickname, email } = req.body;
  await User.create({
    username,
    password,
    nickname,
    email,
  });
  return res.redirect("login");
};
```

## Password
### Hashing
- passwordë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ë©´ ì‰½ê²Œ ë…¸ì¶œë˜ë¯€ë¡œ hashing í•´ì¤€ë‹¤.
- Hashingì€ ì¼ë°©í–¥ í•¨ìˆ˜ì´ë‹¤.
- ì…ë ¥ê°’ì„ ì…ë ¥í•˜ë©´ ì¶œë ¥ê°’ì´ ë‚˜ì˜¤ì§€ë§Œ ì¶œë ¥ê°’ìœ¼ë¡œ ì…ë ¥ê°’ì„ ì•Œì•„ë‚¼ ìˆ˜ ì—†ë‹¤.

#### bcrypt
- rainbow table ê³µê²©ì„ ë§‰ì•„ì¤€ë‹¤.
ğŸ”§ `npm install bcrypt`

í•´ì‹±í•˜ê¸°
```js
userSchema.pre("save", async function () {
  this.password = await bcrypt.hash(this.password, 5);
});
```
ğŸ’¡ìˆ«ì 5: salt íšŸìˆ˜ì´ë‹¤.

##### bcrypt.compare
- ë¡œê·¸ì¸ í•  ë•Œ ìœ ì €ê°€ formì— ì…ë ¥í•œ ìˆ«ìë¥¼ í•´ì‹±í•œ ê°’ê³¼<br>
  íšŒì›ê°€ì…ì‹œ í•´ì‹±ëœ ê°’ì„ ë¹„êµí•˜ì—¬ ë¡œê·¸ì¸ ì„±ê³µì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.
```js 
const ok = await bcrypt.compare(password, user.password);
```

## Login
### ë¡œê·¸ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥

```js
const usernameExists = await User.exists({ username: username });
  if (usernameExists) {
    return res.render("join", { pageTitle: "Join", errorMessage: "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." });
  }
```

### íšŒì›ê°€ì… ì„±ê³µì—¬ë¶€ ì•Œë ¤ì£¼ê¸°
ì¡°ê±´ì— ì˜í•´ íšŒì›ê°€ì…ì´ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ëœ¨ì§€ë§Œ<br> 
ë¸Œë¼ìš°ì €ì—ì„œ ì„±ê³µí•œì¤„ ì•Œê³  ì•„ì´ë””ì™€ ì•”í˜¸ë¥¼ ì €ì¥í•˜ë ¤ê³  í•œë‹¤.<br>
ê·¸ë˜ì„œ ìƒíƒœ ì½”ë“œë¥¼ ì´ìš©í•˜ì—¬ ì„±ê³µ ì—¬ë¶€ë¥¼ ì•Œë ¤ì¤Œìœ¼ë¡œ í•´ê²°í•œë‹¤.

#### status code
- HTTP ì‘ë‹µ ìƒíƒœë¥¼ ì•Œë ¤ì£¼ëŠ” ì½”ë“œì´ë‹¤.

<a target="_blank" href="https://ko.wikipedia.org/wiki/HTTP_%EC%83%81%ED%83%9C_%EC%BD%94%EB%93%9C">HTTP ì‘ë‹µ ìƒíƒœ ì½”ë“œ ëª©ë¡</a>

2xx : success 
4xx : client errors 

=> 200ë²ˆëŒ€ ìƒíƒœì½”ë“œë¥¼ ë°›ëŠ”ë‹¤ë©´ URLì„ Historyì— ì €ì¥í•˜ì§€ë§Œ<br>
   400ë²ˆëŒ€ ìƒíƒœì½”ë“œë¥¼ ë°›ìœ¼ë©´ URLì„ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
```js
if (password !== password2) {
    return res.status(400).render("join", { pageTitle, errorMessage: "íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
  }
```

### ì¿ í‚¤
- ì •ë³´ë¥¼ ì£¼ê³ ë°›ëŠ” ë°©ì‹ì´ë©° session IDë¥¼ ì €ì¥í•˜ê³  ì „ì†¡í•œë‹¤.

#### ì„¸ì…˜
- backendì™€ browserê°„ì— ì–´ë–¤ í™œë™ì„ í–ˆëŠ”ì§€ ê¸°ì–µí•œë‹¤.

##### express-session
- expressì—ì„œ ì„¸ì…˜ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¯¸ë“¤ì›¨ì–´.

ğŸ”§ `npm install express-session`

server.js //Router ìœ„ì— ì¶”ê°€
```js
app.use(
  session({
    secret: "Hello!",
    resave: true,
    saveUninitialized: true,
  })
);
```
=> ìœ„ì˜ ë¯¸ë“¤ì›¨ì–´ê°€ ì‚¬ì´íŠ¸ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ê¸°ì–µí•˜ê²Œ ëœë‹¤.

ğŸ’¡ resave : ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ë„ ì €ì¥
ğŸ’¡ saveUninitialized : ì„¸ì…˜ ì´ˆê¸°í™” ì „ì—ë„ ì €ì¥

##### MongoDBì— ì„¸ì…˜ ì €ì¥
```js
export const postLogin = async (req, res) => {
  const { pageTitle } = "ë¡œê·¸ì¸";
  const { username, password } = req.body;
  const user = await User.findOne({ username });
  if (!user) {
    return res.status(400).render("login", { pageTitle, errorMessage: "ì•„ì´ë””ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
  }
  const ok = await bcrypt.compare(password, user.password);
  if (!ok) {
    return res.status(400).render("login", { pageTitle, errorMessage: "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
  }
  req.session.loggedIn = true;
  req.session.user = user;
  res.redirect("/");
};
```
##### locals ì „ì—­ë³€ìˆ˜
- res.locals objectë¥¼ ì´ìš©í•˜ë©´ templateì— ì „ì—­ì ìœ¼ë¡œ ë³€ìˆ˜ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.

middlewares.js ìƒì„±
```js
export const localsMiddleware = (req, res, next) => {
  res.locals.loggedIn = Boolean(req.session.loggedIn);
  res.locals.siteName = "á¼ˆÎ³Î¿ÏÎ¬";
  res.locals.loggedInUser = req.session.user;
  next();
};
```
`server.js`ì—ì„œ `middlewares.js` ì‚¬ìš©í•˜ê¸°
```js
app.set("view engine", "pug");
app.set("views", process.cwd() + "/src/views");
app.use(logger);
app.use(express.urlencoded({ extended: true }));
app.use(
  session({
    secret: "Hello!",
    resave: true,
    saveUninitialized: true,
  })
);
app.use(localsMiddleware);
app.use("/", globalRouter);
app.use("/users", userRouter);
app.use("/posts", postRouter);
```
`base.pug`ì—ì„œ localsì— ìˆëŠ” ì „ì—­ë³€ìˆ˜ loggedIn ì‚¬ìš©ì˜ˆì‹œ
```js
if loggedIn
    li 
        a(href="/users/logout") ë¡œê·¸ì•„ì›ƒ
    li 
        a(href="/posts/upload") ê¸€ì“°ê¸° 
else
    li 
        a(href="/login") ë¡œê·¸ì¸
    li 
        a(href="/join") íšŒì›ê°€ì…
```

â­ ì •ë¦¬
1. ë¸Œë¼ìš°ì €(í´ë¼ì´ì–¸íŠ¸)ê°€ ì„œë²„ì— ì ‘ê·¼
2. ì„œë²„ê°€ ë¸Œë¼ìš°ì €ì—ê²Œ ì¿ í‚¤ë¥¼ ì¤Œ
3. ì„¸ì…˜ì— ì¿ í‚¤ì™€ ê´€ë ¨ëœ ì •ë³´ë¥¼ ì €ì¥
4. ë¸Œë¼ìš°ì €ê°€ ì„œë²„ì— ë‹¤ì‹œ ì ‘ê·¼í•  ë•Œ ì¿ í‚¤ë¥¼ ë³´ì—¬ì¤Œ
5. ì„œë²„ëŠ” ì¿ í‚¤ë¥¼ í†µí•´ ë¸Œë¼ìš°ì €ë¥¼ êµ¬ë¶„

#### Mongo Store
- ssession dataë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.

<a target="_blank" href="https://www.npmjs.com/package/connect-mongo">connect-mongoì— ëŒ€í•´ ì•Œì•„ë³´ê¸°</a>

ğŸ’¡ğŸ’¡ğŸ’¡
<hr>
- ì¿ í‚¤ ì•ˆì—ëŠ” session IDë§Œ ì €ì¥ë˜ê³  session dataëŠ” ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
- session dataëŠ” ì„œë²„ìª½ì— ì €ì¥ëœë‹¤.
<hr>

ğŸ”§ `npm install connect-mongo`

```js
app.use(
  session({
    secret: "Hello!",
    resave: true,
    saveUninitialized: true,
    store: mongoStore.create({ mongoUrl: "mongodb://127.0.0.1:27017/agora" }),
  })
);
```
Mongo DB
```js
> show collections
posts
sessions
users
```
=> Mongo DBì—ì„œ sessionsê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ìƒì„±ëœ ì„¸ì…˜ í™•ì¸
```js
> db.sessions.find()
{ "_id" : "Qa6Yf2mv3WBnm-PSS92vhHMSJITcz02G", "expires" : ISODate("2022-09-13T04:25:12.466Z"), "session" : "{\"cookie\":{\"originalMaxAge\":null,\"expires\":null,\"httpOnly\":true,\"path\":\"/\"}}" }
```

#### Session authentication(ì„¸ì…˜ ì¸ì¦) ë¬¸ì œ
- ëª¨ë“  ë°©ë¬¸ìì— ëŒ€í•´ ì¿ í‚¤ë¥¼ ì €ì¥í•˜ëŠ” ë¬¸ì œ

resave & saveUninitialized falseë¡œ ë³€ê²½
- server.js
```js
app.use(
  session({
    secret: "Hello!",
    resave: false,
    saveUninitialized: false,
    cookie: {
      maxAge: 20000,
    },
    store: MongoStore.create({ mongoUrl: "mongodb://127.0.0.1:27017/agora" }),
  })
);
```
ğŸ’¡ secret : ì¿ í‚¤ì— signí•  ë•Œ ì‚¬ìš©í•˜ëŠ” string  //session hijackì„ ë°©ì§€í•˜ê¸° ìœ„í•¨ì´ë‹¤.
ğŸ’¡ resave : ë³€ê²½ ì‚¬í•­ì´ ì—†ì–´ë„ ì €ì¥
ğŸ’¡ saveUninitialized : ì„¸ì…˜ ì´ˆê¸°í™” ì „ì—ë„ ì €ì¥
ğŸ’¡ maxAge: ì¿ í‚¤ë¥¼ ìœ ì§€í•  ì‹œê°„ì„ ì •í•¨  // 20000 -> 20ì´ˆ
##### Token authentication
- IOS or ì•ˆë“œë¡œì´ë“œëŠ” ì¿ í‚¤ë¥¼ ê°–ì§€ ì•Šê¸° ë•Œë¬¸ì— tokenì„ ì‚¬ìš©í•¨

#### Url ë¹„ê³µê°œ
environment file(í™˜ê²½ë³€ìˆ˜)
`.env` ìƒì„±
- ì½”ë“œì— ë“¤ì–´ê°€ë©´ ì•ˆë˜ëŠ” ê°’ë“¤ì„ ì§€ì •

- `/.env`
```js
COOKIE_SECRET = [YOUR Cookie Secret]
DB_URL = [YOUR DB URL]
```
ì‚¬ìš© ë°©ë²•
- `server.js` 
```js
app.use(
  session({
    secret: process.env.COOKIE_SECRET,
    resave: false,
    saveUninitialized: false,
    store: MongoStore.create({ mongoUrl: process.env.DB_URL }),
  })
);
```
=> ê·¸ëŸ¬ë‚˜ ì§€ê¸ˆì€ COOKIE_SECRETê³¼ DB_URLì„ ì¶œë ¥í•˜ë©´ undefinedë¥¼ ë°˜í™˜ë°›ëŠ”ë‹¤.

âš ï¸ gitignoreì—ë„ .env ì¶”ê°€í•˜ê¸°!!

##### dotenv

ğŸ”§ `npm install dotenv`

ê°€ëŠ¥í•œ ì œì¼ ë¨¼ì € ì‹¤í–‰í•˜ê²Œ í•´ì¤€ë‹¤.
- init.js
```js
import "dotenv/config";
```

### ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸í•˜ê¸°

1. Github-Settings-Oauth Apps-new OAuth App í´ë¦­
2.
3. login.pugì— github ë¡œê·¸ì¸ ì£¼ì†Œ ì¶”ê°€
```js
form(method="POST")
        input(name="username" type="text" placeholder="ì•„ì´ë””" required)
        input(name="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required)
        input(type="submit" value="ë¡œê·¸ì¸")
        br
        a(href="https:/github.com/login/oauth/authorize?[Client ID]") Githubë¡œ ë¡œê·¸ì¸í•˜ê¸° &rarr;
```

#### scope
- ìœ ì €ì—ê²Œ ì–´ë–¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì¸ì§€ ì„¤ì •

email ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê¸°
```js
a(href="https:/github.com/login/oauth/authorize?[Client ID]&scope=user:email")
```
ê²°ê³¼ =>
oauth-scope-email.png


##### URL ì •ë¦¬í•˜ê¸°




githubì—ì„œ ì¤€ codeë¥¼ Access Tokenìœ¼ë¡œ ë°”ê¿”ì¤€ë‹¤.


âš ï¸ client_secretì€ ë¬´ì¡°ê±´ backendì— ì¡´ì¬í•´ì•¼í•œë‹¤.

 codeëŠ” 10ë¶„ì´ë©´ ë§Œë£Œí•œë‹¤.

 npm install node-fetch@2.6.1

### ë¡œê·¸ì•„ì›ƒ
```js
export const logout = (req, res) => {
  req.session.destroy();
  res.redirect("/");
};
```