---
layout: page
title: "í’€ìŠ¤íƒ ë§›ë³´ê¸°7-MongoDB"
author: author1
comments: true
description: >
hide_description: true
sitemap: true
---

0. this unordered seed list will be replaced by toc as unordered list 
{:toc}

## MongoDB
- Json í˜•ì‹ê³¼ ê°™ì€ ë¬¸ì„œ ê¸°ë°˜(document-based) ë°ì´í„°ë² ì´ìŠ¤. //ì¼ë°˜ì ìœ¼ë¡œ sql based

ì‚¬ìš©ë²• (WSL ê¸°ì¤€)
`sudo mongod --dbpath ~/data/db`

ë‹¤ë¥¸ í”„ë¡¬í”„íŠ¸
`mongo` ì…ë ¥ í›„ ì‹¤í–‰

### ëª…ë ¹ì–´

#### ìƒíƒœ í™•ì¸
##### db ìƒíƒœ
`show dbs`

##### collection ìƒíƒœ
collection í™•ì¸
`show collections`

#### db ì‚¬ìš©
use [DB ì´ë¦„]


#### ì‚­ì œ
##### DB ì‚­ì œ
use [DB ì´ë¦„]
`db.dropDatabase()`

##### collection ì‚­ì œ
`db.[ì‚­ì œí•  collection ì´ë¦„].drop()`

## Mongoose
- node.JSì™€ MongoDBì˜ ë‹¤ë¦¬ ì—­í• ì„ í•˜ëŠ” íŒ¨í‚¤ì§€.

ğŸ”§ `npm install mongoose`

src/db.js ìƒì„± //server.jsì™€ ê°™ì€ í´ë”ì— ë§Œë“¤ì–´ì¤Œ

í”„ë¡¬í”„íŠ¸ì°½ì— mongo ì…ë ¥ í›„ ìƒë‹¨ì— ìˆëŠ” ì£¼ì†Œë¥¼ ê°€ì ¸ì™€ì„œ ì ìš©.

### DB ì—°ê²°

1. DB ì—°ê²° ìœ„ì¹˜ ì„¤ì •
/src/db.js
```js
import mongoose from "mongoose";

mongoose.connect("mongodb://127.0.0.1:27017/[ì‚¬ìš©í•  DBëª…]");
```
2. ì„œë²„ì— db.jsíŒŒì¼ import
src/server.js
```js
import "./db.js";
```
3. ì—°ê²° ì—¬ë¶€ì™€ ì—ëŸ¬ë¥¼ ë©”ì‹œì§€ë¡œ ë°›ê¸° 
/src/db.js
```js
import mongoose from "mongoose";

mongoose.connect("mongodb://127.0.0.1:27017/agora");

const db = mongoose.connection;

const handleOpen = () => console.log("ğŸ’¡ Connected to DB ğŸ”—");
const handleError = (error) => console.log("DB Error", error);

db.on("error", handleError);
db.once("open", handleOpen);
```
ğŸ’¡once : í•œë²ˆë§Œ ì‹¤í–‰

### Model
- MongoDBì—ì„œ ë¬¸ì„œë¥¼ ë§Œë“¤ê³  ì½ëŠ”ë‹¤.
- Schema ì •ì˜ì—ì„œ ì»´íŒŒì¼ëœ ìƒì„±ìì´ë‹¤.

src/models/Post.js í´ë”ì™€ íŒŒì¼ ìƒì„±

#### Schema
- ë°ì´í„° í˜•ì‹ì„ ì§€ì •í•œë‹¤.

src/models/Post.js
ë°©ì‹ 1. ê¸°ë³¸
```js
import mongoose, { mongo } from "mongoose";

const postSchema = new mongoose.Schema({
  title: String,
  content: String,
  createdAt: Date,
  hashtags: [{ type: String }],
  meta: {
    views: Number,
    likes: Number,
  },
});

const Post = mongoose.model("Post", postSchema);
export default Post;
```
ë°©ì‹ 2. Type ì¶”ê°€
```js
const postSchema = new mongoose.Schema({
  title: { type: String, required: true },
  content: { type: String, required: true },
  createdAt: { type: Date, required: true, default: Date.now },
  hashtags: [{ type: String }],
  meta: {
    views: { type: Number, default: 0, required: true },
    likes: { type: Number, default: 0, required: true },
  },
});
```

/src/server.js
```js
import "./db.js";
import "./models/Post.js";
```
=> Post.jsë¥¼ import ì‹œí‚¤ë¯€ë¡œ show dbsë¥¼ í†µí•´ ì—°ê²°ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<hr>
=> dbë¥¼ mongooseì™€ ì—°ê²°ì‹œì¼œì„œ post modelì„ ì¸ì‹ì‹œí‚¨ë‹¤.
<hr> 

##### SchemaTypes
<a target="_blank" href="https://mongoosejs.com/docs/schematypes.html">ìŠ¤í‚¤ë§ˆ íƒ€ì… í™•ì¸í•˜ê¸°</a>

**trim**

"He  ll o !".trim()
=> "Hello!"

ì‚¬ìš© ì˜ˆì‹œ.
```js
hashtags: [{ type: String, trim: true }]
```
***Length***
- ë¬¸ìì—´ì˜ ìµœëŒ€/ìµœì†Œ ê¸¸ì´

*minLength* & *maxLength*
```js
title: { type: String, required: true, minLength: 1, maxLength: 30 },
```

#### Mongoose Query
<a target="_blank" href="https://mongoosejs.com/docs/queries.html">Mongoose Query ì‚´í´ë³´ê¸°</a>

##### Model.exists({})
- í•„í„°ì— ë”°ë¼ ì¡´ì¬ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤.

ì˜ˆì‹œ. 
```js
Model.exists({title: "hello"})
Model.exists({_id: [id]})
```
=> ì¡´ì¬ì—¬ë¶€ì— ë”°ë¼ ê°’ í˜¹ì€ Nullì´ ë‚˜ì˜¨ë‹¤.

##### Model.find()
```js
const posts = await Post.find({}).sort({ createdAt: "desc" });
```
=> argumentì— ë”°ë¼ ì˜¤ë¦„ì°¨ìˆœ, ë‚´ë¦¼ì°¨ìˆœ ì„¤ì • ê°€ëŠ¥ 

##### Model.findById()
- í•´ë‹¹ idë¥¼ ê²€ìƒ‰í•˜ê³  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤. 

ì˜ˆì‹œ. í•´ë‹¹ idë¥¼ ê°€ì§€ê³  ìˆëŠ” post ê°€ì ¸ì˜¤ê¸°
```js
const { id } = req.params;
const post = await Post.findById(id);
```
##### Model.create()

##### Model.findByIdAndUpdate()

##### Model.findOneAndUpdate()

##### Model.findByIdAndDelete()
ì˜ˆì‹œ. ê²Œì‹œë¬¼ ì‚­ì œ
```js
export const deletePost = async (req, res) => {
  const { id } = req.params;
  await Post.findByIdAndDelete(id);
  return res.redirect("/");
};
```
ğŸ’¡ findByIdAndDelete(id) === findByIdAndDelete({_id:id})

### Mongoos Middleware
```js
postSchema.pre("save", async function () {
  console.log("We are about to save: ", this);
});
```
console.log ê²°ê³¼ => 
```
We are about to save:  {
  title: 'abc',
  content: 'abcde',
  hashtags: [ '#aa', '#bb', '#cc' ],
  meta: { views: 0, likes: 0 },
  _id: new ObjectId("630c01ab5071f4572543f50d"),
  createdAt: 2022-08-29T00:00:43.087Z
}
```


### Call back í•¨ìˆ˜
#### function ì†ì˜ function
```js
export const home = (req, res) => {
    console.log("Start");
  Post.find({}, (error, posts) => {
      console.log(posts);
      console.log("Hello");
  });
  console.log("Finish");
  return res.render("home", { pageTitle: "á¼ˆÎ³Î¿ÏÎ¬", fakeUser: fakeUser, posts: [] });
};
```
=> findê°€ ì˜¤ë˜ ê±¸ë¦°ë‹¤ë©´ ìˆœì„œê°€ ê¼¬ì¼ ìˆ˜ ìˆë‹¤.

ğŸ’¡ë‘ë²ˆì§¸ ì¤„ `{}`ì€ ëª¨ë“  ê²ƒì„ ì˜ë¯¸í•œë‹¤.

â­ ì¶œë ¥ ìˆœì„œ(findê°€ ì˜¤ë˜ê±¸ë¦° ê²½ìš°) â­
```js
Start
Finish
Hello
[]
```
=> Callback í•¨ìˆ˜ì˜ íŠ¹ì„±ì— ë”°ë¼ "Finish" ì „ì— "Hello"ê°€ ë¨¼ì € ë‚˜ì˜¨ë‹¤.

### Promise
#### async & await
- awaitì´ ìˆë‹¤ë©´ JSëŠ” ê²°ê³¼ê°’ì„ ë°›ì„ ë•Œê¹Œì§€ ê³„ì† ê¸°ë‹¤ë ¤ì¤€ë‹¤.

```js
export const home = async (req, res) => {
    console.log("Start");
    const posts = await Post.find({});
    console.log(posts);
    console.log("Hello");
    console.log("Finish");
    return res.render("home", { pageTitle: "á¼ˆÎ³Î¿ÏÎ¬", fakeUser: fakeUser, posts: [] });
};
```
â­ ì¶œë ¥ ìˆœì„œ â­
```js
Start
[]
Hello
Finish
```
=> call back í•¨ìˆ˜ë³´ë‹¤ ë” ì§ê´€ì ì´ë‹¤.

#### try & catch
- try ë¶€ë¶„ì„ ì‹¤í–‰í•˜ê³  ì˜¤ë¥˜ê°€ ë‚œë‹¤ë©´ catchë¥¼ ì‹¤í–‰í•œë‹¤.

```js
export const home = async (req, res) => {
  try {
    console.log("Start");
    const posts = await Post.find({});
    console.log(posts);
    console.log("Finish");
    return res.render("home", { pageTitle: "á¼ˆÎ³Î¿ÏÎ¬", fakeUser: fakeUser, posts: [] });
  } catch {
    return res.render("Error");
  }
};
```





### DBì— ì €ì¥í•˜ê¸°
1. JS Objectë¥¼ ë§Œë“¤ê¸°

2. í•´ë‹¹ Objectë¥¼ ì €ì¥
src/controllers/postController.js
ë°©ë²• 1. new, object, save
```js
export const postUpload = async (req, res) => {
  const { title, content, hashtags } = req.body;
  const post = new Post({
    title: title,
    content: content,
    createdAt: Date.now(),
    hashtags: hashtags.split(",").map((word) => `#${word}`),
    meta: {
      views: 0,
      likes: 0,
    },
  });
  await post.save();
  return res.redirect("/");
};
```
=> ì§ì ‘ saveë¥¼ í•´ì¤˜ì•¼ í•œë‹¤.

ë°©ë²• 2. create
```js
export const postUpload = async (req, res) => {
  const { title, content, hashtags } = req.body;
  await Post.create({
    title: title,
    content: content,
    createdAt: Date.now(),
    hashtags: hashtags.split(",").map((word) => `#${word}`),
    meta: {
      views: 0,
      likes: 0,
    },
  });
  return res.redirect("/");
};
```
=> ë”°ë¡œ saveí•  í•„ìš”ê°€ ì—†ë‹¤.
